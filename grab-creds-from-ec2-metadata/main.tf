locals {
  metadata_endpoint = var.is_local_environment ? "localhost:1338" : "169.254.169.254"
  role_name = data.http.role_name.body
  credentials_map = jsondecode(data.http.credentials.body)
  access_key_id = lookup(local.credentials_map, "AccessKeyId")
  secret_access_key = lookup(local.credentials_map, "SecretAccessKey")
  token = lookup(local.credentials_map, "Token")
}

data "http" "role_name" {
  url = "http://${local.metadata_endpoint}/latest/meta-data/iam/security-credentials/"
}

data "http" "credentials" {
  url = "http://${local.metadata_endpoint}/latest/meta-data/iam/security-credentials/${data.http.role_name.body}"
  depends_on = [data.http.role_name]
}

variable "is_local_environment" {
  description = "If you launch this locally using amazon-ec2-metadata-mock, then it will use localhost:1338. If not, it will assume it can try the EC2 metadata IP (169.254.169.254)"
  default = true
}

output "role_name" {
  value = data.http.role_name.body
}

output "credentials" {
  value = data.http.credentials.body
}

output "access_key" {
  value = local.access_key_id
}

output "secret_access_key" {
  value = local.secret_access_key
}

output "token" {
  value = local.token
}

# Mock this: https://github.com/aws/amazon-ec2-metadata-mock